name: ğŸ§ª Tests and Quality Checks

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  test:
    name: ğŸ Test Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12"]
        
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: ğŸ”§ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pytest pytest-cov
        
    - name: ğŸ” Import test
      run: |
        python -c "import vertex_ai_imagen; print(f'âœ… ë²„ì „: {vertex_ai_imagen.__version__}')"
        python -c "from vertex_ai_imagen import ImagenClient; print('âœ… ImagenClient import ì„±ê³µ')"
        
    - name: ğŸ§ª Run basic tests
      run: |
        python -c "
        from vertex_ai_imagen import ImagenClient, ImageRequest
        print('âœ… ëª¨ë“  í´ë˜ìŠ¤ import ì„±ê³µ')
        
        # ê¸°ë³¸ ê°ì²´ ìƒì„± í…ŒìŠ¤íŠ¸
        try:
            request = ImageRequest(prompt='test', model='imagen-3.0-generate-001')
            print('âœ… ImageRequest ê°ì²´ ìƒì„± ì„±ê³µ')
        except Exception as e:
            print(f'âŒ ImageRequest ìƒì„± ì‹¤íŒ¨: {e}')
            exit(1)
        "

  lint:
    name: ğŸ” Code Quality Checks  
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.x"
        
    - name: ğŸ”§ Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy
        
    - name: ğŸ–¤ Check code formatting with black
      run: |
        black --check --diff src/ || echo "âš ï¸ Black formatting issues found (not blocking)"
        
    - name: ğŸ“¦ Check import sorting with isort
      run: |
        isort --check-only --diff src/ || echo "âš ï¸ Import sorting issues found (not blocking)"
        
    - name: ğŸ” Check code style with flake8
      run: |
        flake8 src/ --max-line-length=88 --extend-ignore=E203,W503 || echo "âš ï¸ Style issues found (not blocking)"

  build-test:
    name: ğŸ—ï¸ Build Test
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.x"
        
    - name: ğŸ”§ Install build tools
      run: |
        python -m pip install --upgrade pip
        pip install build twine
        
    - name: ğŸ—ï¸ Build package
      run: python -m build
      
    - name: ğŸ” Check package
      run: twine check dist/*
      
    - name: ğŸ“Š Show build results
      run: |
        echo "ğŸ“¦ ë¹Œë“œëœ íŒŒì¼ë“¤:"
        ls -la dist/
        echo ""
        echo "ğŸ“ íŒŒì¼ í¬ê¸°:"
        du -h dist/* 